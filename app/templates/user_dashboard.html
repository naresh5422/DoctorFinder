{% extends "base.html" %}

{% block title %}My Dashboard{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">My Dashboard</h1>
        <a href="{{ url_for('user_profile') }}" class="btn btn-outline-secondary"><i class="bi bi-person-circle me-2"></i>Edit Profile</a>
    </div>

    <!-- Stats Cards -->
    <div class="row g-4 mb-5 row-cols-1 row-cols-md-3 row-cols-lg-5">
        <div class="col">
            <a href="{{ url_for('my_appointments', view='appointments') }}" class="text-decoration-none">
                <div class="card stat-card border-top-primary text-center h-100">
                    <div class="card-body">
                        <h5 class="card-title text-muted">Total Appointments</h5>
                        <p class="stat-number">{{ total_appointments or 0 }}</p>
                    </div>
                </div>
            </a>
        </div>
        <div class="col">
            <a href="{{ url_for('my_appointments', status='Pending') }}" class="text-decoration-none">
                <div class="card stat-card border-top-warning text-center h-100">
                    <div class="card-body">
                        <h5 class="card-title text-muted">Pending Appointments</h5>
                        <p class="stat-number">{{ pending_appointments_count or 0 }}</p>
                    </div>
                </div>
            </a>
        </div>
        <div class="col">
            <a href="{{ url_for('my_appointments', status='Confirmed') }}" class="text-decoration-none">
                <div class="card stat-card border-top-success text-center h-100">
                    <div class="card-body">
                        <h5 class="card-title text-muted">Confirmed Appointments</h5>
                        <p class="stat-number">{{ confirmed_appointments_count or 0 }}</p>
                    </div>
                </div>
            </a>
        </div>
        <div class="col">
            <a href="{{ url_for('my_appointments', status='Completed') }}" class="text-decoration-none">
                <div class="card stat-card border-top-info text-center h-100">
                    <div class="card-body">
                        <h5 class="card-title text-muted">Consultations Completed</h5>
                        <p class="stat-number">{{ consultations_completed_count or 0 }}</p>
                    </div>
                </div>
            </a>
        </div>
        <div class="col">
            <a href="{{ url_for('my_appointments', view='conversations') }}" class="text-decoration-none">
                <div class="card stat-card border-top-secondary text-center h-100">
                    <div class="card-body">
                        <h5 class="card-title text-muted">Doctor Conversations</h5>
                        <p class="stat-number">{{ total_conversations_count or 0 }}</p>
                    </div>
                </div>
            </a>
        </div>
    </div>

    <div class="row g-5">
        <div class="col-lg-8">
            <!-- Upcoming Appointments -->
            <h3 class="mb-3">Upcoming Appointments</h3>
            {% if upcoming_appointments %}
                <div class="list-group">
                    {% for appt in upcoming_appointments %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">Dr. {{ appt.doctor.doctor_name }}</h5>
                                <small class="text-muted">{{ appt.appointment_date.strftime('%a, %b %d, %Y') }} at {{ appt.appointment_date.strftime('%I:%M %p') }}</small>
                            </div>
                            <p class="mb-1">Reason: {{ appt.reason or 'Not specified' }}</p>
                            <small>Status: <span class="badge bg-{{ 'warning' if appt.status == 'Pending' else 'success' }}">{{ appt.status }}</span></small>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center p-4 border rounded bg-light">
                    <p class="mb-0 text-muted">You have no upcoming appointments.</p>
                    <a href="{{ url_for('browse_doctors') }}" class="btn btn-primary btn-sm mt-2">Book an Appointment</a>
                </div>
            {% endif %}

            <!-- My Reviews -->
            <h3 class="mb-3 mt-5">My Reviews ({{ reviews_given|length }})</h3>
            {% if reviews_given %}
                <div class="list-group">
                    {% for review in reviews_given %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">Review for Dr. {{ review.doctor.doctor_name }}</h5>
                                <small class="text-muted">{{ review.timestamp.strftime('%b %d, %Y, %I:%M %p') }}</small>
                            </div>
                            <div class="rating-stars my-1">
                                {% for i in range(review.rating|int) %}<i class="bi bi-star-fill text-warning"></i>{% endfor %}{% for i in range(5 - (review.rating|int)) %}<i class="bi bi-star text-warning"></i>{% endfor %}
                            </div>
                            <p class="mb-1">{{ review.comment }}</p>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center p-4 border rounded bg-light">
                    <p class="mb-0 text-muted">You haven't written any reviews yet.</p>
                </div>
            {% endif %}
        </div>

        <div class="col-lg-4">
            <!-- Recent Searches -->
            <h3 class="mb-3">Recent Searches</h3>
            {% if recent_searches %}
                <div class="list-group">
                    {% for search in recent_searches %}
                        <a href="{{ url_for('repeat_search', search_id=search.id) }}" class="list-group-item list-group-item-action">
                            <div class="fw-bold">{{ search.disease }}</div>
                            <small class="text-muted">{{ search.location }}</small>
                        </a>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-muted">No recent searches.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}