{% extends "base.html" %}

{% block title %}Manage Availability{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">Manage Your Available Slots</h1>
        <form id="slots-form" method="POST">
            <input type="hidden" name="slots_data" id="slots-data-input">
            <button type="submit" class="btn btn-primary btn-lg"><i class="bi bi-save me-2"></i>Save All Changes</button>
        </form>
    </div>

    <div class="card">
        <div class="card-body">
            <div class="row g-0">
                <!-- Calendar View -->
                <div class="col-lg-7 border-end">
                    <div id="calendar-container" class="p-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <button id="prev-month" class="btn btn-outline-secondary"><i class="bi bi-chevron-left"></i></button>
                            <h4 id="month-year" class="mb-0"></h4>
                            <button id="next-month" class="btn btn-outline-secondary"><i class="bi bi-chevron-right"></i></button>
                        </div>
                        <div class="calendar-grid">
                            <div class="calendar-header">Sun</div>
                            <div class="calendar-header">Mon</div>
                            <div class="calendar-header">Tue</div>
                            <div class="calendar-header">Wed</div>
                            <div class="calendar-header">Thu</div>
                            <div class="calendar-header">Fri</div>
                            <div class="calendar-header">Sat</div>
                        </div>
                        <div id="calendar-days" class="calendar-grid">
                            <!-- Days will be generated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Slot Editor -->
                <div class="col-lg-5">
                    <div id="slot-editor" class="p-4">
                        <h5 class="mb-3">Edit Slots for <span id="selected-date-display">...</span></h5>
                        <div id="no-date-selected" class="text-center text-muted p-5">
                            <i class="bi bi-calendar-plus fs-1"></i>
                            <p class="mt-2">Select a date from the calendar to add or remove time slots.</p>
                        </div>
                        <div id="editor-content" style="display: none;">
                            <div class="mb-4">
                                <label class="form-label">Quick Add Slots (30-min intervals)</label>
                                <div id="quick-add-slots" class="d-flex flex-wrap gap-2"></div>
                            </div>
                            <hr>
                            <h6>Existing Slots:</h6>
                            <div id="existing-slots-list" class="d-flex flex-wrap gap-2">
                                <!-- Existing slots will be populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // State
    let current_slots = {{ doctor.available_slots|tojson if doctor.available_slots else '{}' }};
    let currentDate = new Date();
    let selectedDate = null;

    // DOM Elements
    const monthYearEl = document.getElementById('month-year');
    const calendarDaysEl = document.getElementById('calendar-days');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');
    const selectedDateDisplay = document.getElementById('selected-date-display');
    const noDateSelectedView = document.getElementById('no-date-selected');
    const editorContentView = document.getElementById('editor-content');
    const existingSlotsList = document.getElementById('existing-slots-list');
    const slotsForm = document.getElementById('slots-form');
    const slotsDataInput = document.getElementById('slots-data-input');
    const quickAddSlotsContainer = document.getElementById('quick-add-slots');

    function formatTime(timeStr) {
        // Basic validation and formatting
        let time = timeStr.trim().toUpperCase();
        let [hour, minute] = time.replace(/ /g, '').replace('AM', '').replace('PM', '').split(':');
        
        if (!hour || !minute) return null;

        hour = parseInt(hour, 10);
        minute = parseInt(minute, 10);

        if (isNaN(hour) || isNaN(minute) || hour < 1 || hour > 12 || minute < 0 || minute > 59) return null;

        let period = time.includes('PM') ? 'PM' : 'AM';
        if (hour === 12 && period === 'AM') hour = 0; // Midnight case
        if (hour < 12 && period === 'PM') hour += 12; // PM case

        return `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
    }

    function renderCalendar() {
        calendarDaysEl.innerHTML = '';
        const month = currentDate.getMonth();
        const year = currentDate.getFullYear();
        monthYearEl.textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;

        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // Add blank days for the start of the month
        for (let i = 0; i < firstDayOfMonth; i++) {
            calendarDaysEl.innerHTML += `<div class="calendar-day empty"></div>`;
        }

        // Add days of the month
        for (let day = 1; day <= daysInMonth; day++) {
            const dayEl = document.createElement('div');
            dayEl.classList.add('calendar-day');
            dayEl.textContent = day;
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            dayEl.dataset.date = dateStr;

            if (current_slots[dateStr] && current_slots[dateStr].length > 0) {
                dayEl.classList.add('has-slots');
            }
            if (dateStr === selectedDate) {
                dayEl.classList.add('selected');
            }

            dayEl.addEventListener('click', () => {
                selectedDate = dateStr;
                renderCalendar(); // Re-render to show selection
                renderSlotEditor();
            });
            calendarDaysEl.appendChild(dayEl);
        }
    }

    function generateTimeSlots(startHour, endHour, interval) {
        const slots = [];
        for (let hour = startHour; hour < endHour; hour++) {
            for (let minute = 0; minute < 60; minute += interval) {
                const d = new Date(1970, 0, 1, hour, minute);
                slots.push(d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }));
            }
        }
        return slots;
    }

    const predefinedSlots = generateTimeSlots(8, 21, 30); // 8:00 AM to 8:30 PM

    function renderQuickAddSlots() {
        quickAddSlotsContainer.innerHTML = '';
        const existingSlotsForDate = current_slots[selectedDate] || [];

        predefinedSlots.forEach(timeStr => {
            const button = document.createElement('button');
            button.type = 'button';
            button.classList.add('btn', 'btn-sm', 'btn-outline-primary');
            button.textContent = timeStr;
            
            const formattedTime = formatTime(timeStr);
            if (existingSlotsForDate.includes(formattedTime)) {
                button.disabled = true;
                button.classList.replace('btn-outline-primary', 'btn-primary');
            }

            button.addEventListener('click', () => handleAddSlot(formattedTime));
            quickAddSlotsContainer.appendChild(button);
        });
    }

    function renderSlotEditor() {
        if (!selectedDate) {
            noDateSelectedView.style.display = 'block';
            editorContentView.style.display = 'none';
            return;
        }

        noDateSelectedView.style.display = 'none';
        editorContentView.style.display = 'block';
        selectedDateDisplay.textContent = new Date(selectedDate + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        
        existingSlotsList.innerHTML = '';
        const slotsForDate = current_slots[selectedDate] || [];
        
        // Sort slots before rendering
        slotsForDate.sort((a, b) => {
            const timeA = new Date(`1970-01-01T${a}`);
            const timeB = new Date(`1970-01-01T${b}`);
            return timeA - timeB;
        });

        slotsForDate.forEach(slot => {
            const slotPill = document.createElement('div');
            slotPill.classList.add('slot-pill');
            
            // Format 24hr time to 12hr AM/PM for display
            const [h, m] = slot.split(':');
            const displayTime = new Date(1970, 0, 1, h, m).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            
            slotPill.innerHTML = `
                <span>${displayTime}</span>
                <button type="button" class="btn-close btn-close-sm" data-slot="${slot}"></button>
            `;
            slotPill.querySelector('.btn-close').addEventListener('click', (e) => {
                const slotToRemove = e.target.dataset.slot;
                current_slots[selectedDate] = current_slots[selectedDate].filter(s => s !== slotToRemove);
                if (current_slots[selectedDate].length === 0) {
                    delete current_slots[selectedDate];
                }
                renderSlotEditor();
                renderCalendar(); // Update calendar day style
            });
            existingSlotsList.appendChild(slotPill);
        });

        renderQuickAddSlots();
    }

    function handleAddSlot(formattedTime) {
        if (!current_slots[selectedDate]) {
            current_slots[selectedDate] = [];
        }
        if (!current_slots[selectedDate].includes(formattedTime)) {
            current_slots[selectedDate].push(formattedTime);
        }
        renderSlotEditor();
        renderCalendar();
    }

    prevMonthBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
    });

    nextMonthBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
    });

    slotsForm.addEventListener('submit', (e) => {
        slotsDataInput.value = JSON.stringify(current_slots);
    });

    // Initial render
    renderCalendar();
    renderSlotEditor();
});
</script>
{% endblock %}