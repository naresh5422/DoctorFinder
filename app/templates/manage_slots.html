{% extends "base.html" %}

{% block title %}Manage Availability{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">Manage Your Available Slots</h1>
        <form id="slots-form" method="POST">
            <input type="hidden" name="slots_data" id="slots-data-input">
            <button type="submit" class="btn btn-primary btn-lg"><i class="bi bi-save me-2"></i>Save All Changes</button>
        </form>
    </div>

    <div class="card">
        <div class="card-body">
            <div class="row g-0">
                <!-- Calendar View -->
                <div class="col-lg-7 border-end">
                    <div id="calendar-container" class="p-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <button id="prev-month" class="btn btn-outline-secondary"><i class="bi bi-chevron-left"></i></button>
                            <h4 id="month-year" class="mb-0"></h4>
                            <button id="next-month" class="btn btn-outline-secondary"><i class="bi bi-chevron-right"></i></button>
                        </div>
                        <div class="calendar-grid">
                            <div class="calendar-header">Sun</div>
                            <div class="calendar-header">Mon</div>
                            <div class="calendar-header">Tue</div>
                            <div class="calendar-header">Wed</div>
                            <div class="calendar-header">Thu</div>
                            <div class="calendar-header">Fri</div>
                            <div class="calendar-header">Sat</div>
                        </div>
                        <div id="calendar-days" class="calendar-grid">
                            <!-- Days will be generated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Slot Editor -->
                <div class="col-lg-5">
                    <div id="slot-editor" class="p-4">
                        <h5 class="mb-3">Edit Slots for <span id="selected-date-display">...</span></h5>
                        <div id="no-date-selected" class="text-center text-muted p-5">
                            <i class="bi bi-calendar-plus fs-1"></i>
                            <p class="mt-2">Select a date from the calendar to add or remove time slots.</p>
                        </div>
                        <div id="editor-content" style="display: none;">
                            <!-- This dropdown will be shown if doctor offers both types -->
                            {% if doctor.consultation_types == 'Both' %}
                            <div class="mb-3">
                                <label for="consultation-type-select" class="form-label">Select Consultation Type to Edit</label>
                                <select class="form-select" id="consultation-type-select">
                                    <option value="in-person">In-Person</option>
                                    <option value="online">Online</option>
                                </select>
                            </div>
                            {% endif %}

                            <!-- This container will hold the dynamic slot editor -->
                            <div id="slot-editor-panel">
                            <div class="mb-4">
                                <label class="form-label">Quick Add Slots (30-min intervals)</label>
                                <div id="quick-add-slots" class="d-flex flex-wrap gap-2"></div>
                            </div>
                            <hr>
                            <h6>Existing Slots for this type:</h6>
                            <div id="existing-slots-list" class="d-flex flex-wrap gap-2">
                                <!-- Existing slots will be populated by JS -->
                            </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // State
    let raw_slots = {{ doctor.available_slots|tojson|safe if doctor.available_slots else '{}' }};
    const doctor_consult_types = "{{ doctor.consultation_types }}";
    let current_slots = {}; // This will be the normalized, nested structure.
    let currentDate = new Date();
    let selectedDate = null;

    // DOM Elements
    const monthYearEl = document.getElementById('month-year');
    const calendarDaysEl = document.getElementById('calendar-days');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');
    const selectedDateDisplay = document.getElementById('selected-date-display');
    const noDateSelectedView = document.getElementById('no-date-selected');
    const editorContentView = document.getElementById('editor-content');
    const slotsForm = document.getElementById('slots-form');
    const slotsDataInput = document.getElementById('slots-data-input');
    const consultTypeSelect = document.getElementById('consultation-type-select');
    const quickAddSlotsContainer = document.getElementById('quick-add-slots');
    const existingSlotsList = document.getElementById('existing-slots-list');

    // --- Helper Functions ---

    function normalizeSlots(slots) {
        if (!slots || typeof slots !== 'object') return { 'in-person': {}, 'online': {} };
        // If it's already in the new format, just ensure both keys exist.
        if ('online' in slots || 'in-person' in slots) {
            return {
                'in-person': slots['in-person'] || {},
                'online': slots['online'] || {}
            };
        }
        // Handle old, flat structure for backward compatibility.
        const defaultType = (doctor_consult_types === 'Online') ? 'online' : 'in-person';
        const normalized = { 'in-person': {}, 'online': {} };
        normalized[defaultType] = slots;
        return normalized;
    }
    
    function formatTime(timeStr) {
        // Converts 12-hr format (e.g., "8:30 AM") to 24-hr format ("08:30") for storage.
        let time = timeStr.trim().toUpperCase();
        let [hour, minute] = time.replace(/ /g, '').replace('AM', '').replace('PM', '').split(':');
        
        if (!hour || !minute) return null;

        hour = parseInt(hour, 10);
        minute = parseInt(minute, 10);

        if (isNaN(hour) || isNaN(minute) || hour < 1 || hour > 12 || minute < 0 || minute > 59) return null;

        let period = time.includes('PM') ? 'PM' : 'AM';
        if (hour === 12 && period === 'AM') hour = 0; // Midnight case
        if (hour < 12 && period === 'PM') hour += 12; // PM case

        return `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
    }

    // --- Rendering Functions ---

    function renderCalendar() {
        calendarDaysEl.innerHTML = '';
        const month = currentDate.getMonth();
        const year = currentDate.getFullYear();
        monthYearEl.textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;

        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // Add blank days for the start of the month
        for (let i = 0; i < firstDayOfMonth; i++) {
            calendarDaysEl.innerHTML += `<div class="calendar-day empty"></div>`;
        }

        // Add days of the month
        for (let day = 1; day <= daysInMonth; day++) {
            const dayEl = document.createElement('div');
            dayEl.classList.add('calendar-day');
            dayEl.textContent = day;
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            dayEl.dataset.date = dateStr;

            const hasInPersonSlots = current_slots['in-person'] && current_slots['in-person'][dateStr] && current_slots['in-person'][dateStr].length > 0;
            const hasOnlineSlots = current_slots['online'] && current_slots['online'][dateStr] && current_slots['online'][dateStr].length > 0;

            if (hasInPersonSlots || hasOnlineSlots) {
                dayEl.classList.add('has-slots');
            }
            if (dateStr === selectedDate) {
                dayEl.classList.add('selected');
            }

            dayEl.addEventListener('click', () => {
                selectedDate = dateStr;
                renderCalendar(); // Re-render to show selection
                renderSlotEditor();
            });
            calendarDaysEl.appendChild(dayEl);
        }
    }

    function generateTimeSlots(startHour, endHour, interval) {
        const slots = [];
        for (let hour = startHour; hour < endHour; hour++) {
            for (let minute = 0; minute < 60; minute += interval) {
                const d = new Date(1970, 0, 1, hour, minute);
                slots.push(d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }));
            }
        }
        return slots;
    }

    const predefinedSlots = generateTimeSlots(8, 21, 30); // 8:00 AM to 8:30 PM

    function renderSlotEditor() {
        if (!selectedDate) {
            noDateSelectedView.style.display = 'block';
            editorContentView.style.display = 'none';
            return;
        }

        noDateSelectedView.style.display = 'none';
        editorContentView.style.display = 'block';
        selectedDateDisplay.textContent = new Date(selectedDate + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        renderPanel();
    }

    function renderPanel() {
        const selectedType = (doctor_consult_types === 'Both') ? consultTypeSelect.value : doctor_consult_types.toLowerCase();
        const otherType = selectedType === 'in-person' ? 'online' : 'in-person';

        const slotsForOtherType = (current_slots[otherType] && current_slots[otherType][selectedDate]) ? current_slots[otherType][selectedDate] : [];
        const slotsForCurrentType = (current_slots[selectedType] && current_slots[selectedType][selectedDate]) ? current_slots[selectedType][selectedDate] : [];

        // Render Quick Add buttons
        quickAddSlotsContainer.innerHTML = '';
        predefinedSlots.forEach(timeStr => {
            const formattedTime = formatTime(timeStr);

            // Don't show a quick-add button if it's already taken by the other consultation type
            if (slotsForOtherType.includes(formattedTime)) {
                return; // Skip this iteration
            }

            const button = document.createElement('button');
            button.type = 'button';
            button.classList.add('btn', 'btn-sm', 'btn-outline-primary');
            button.textContent = timeStr;

            // Disable it if it's already added for the current type
            if (slotsForCurrentType.includes(formattedTime)) {
                button.disabled = true;
                button.classList.replace('btn-outline-primary', 'btn-primary');
            }

            button.addEventListener('click', () => handleAddSlot(formattedTime, selectedType));
            quickAddSlotsContainer.appendChild(button);
        });

        // Render Existing Slots pills
        existingSlotsList.innerHTML = '';
        const sortedSlotsForCurrentType = [...slotsForCurrentType].sort((a, b) => new Date(`1970-01-01T${a}`) - new Date(`1970-01-01T${b}`));

        sortedSlotsForCurrentType.forEach(slot => {
            const slotPill = document.createElement('div');
            slotPill.classList.add('slot-pill');

            const [h, m] = slot.split(':');
            const displayTime = new Date(1970, 0, 1, h, m).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });

            slotPill.innerHTML = `<span>${displayTime}</span><button type="button" class="btn-close btn-close-sm"></button>`;
            
            const removeBtn = slotPill.querySelector('.btn-close');
            removeBtn.addEventListener('click', () => {
                current_slots[selectedType][selectedDate] = current_slots[selectedType][selectedDate].filter(s => s !== slot);
                if (current_slots[selectedType][selectedDate].length === 0) {
                    delete current_slots[selectedType][selectedDate];
                }
                renderPanel();
                renderCalendar();
            });

            existingSlotsList.appendChild(slotPill);
        });
    }

    // --- Event Handlers & Initialization ---

    function handleAddSlot(formattedTime, consultType) {
        if (!current_slots[consultType]) {
            current_slots[consultType] = {};
        }
        if (!current_slots[consultType][selectedDate]) {
            current_slots[consultType][selectedDate] = [];
        }
        if (!current_slots[consultType][selectedDate].includes(formattedTime)) {
            current_slots[consultType][selectedDate].push(formattedTime);
        }
        renderPanel();
        renderCalendar();
    }

    prevMonthBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
    });

    nextMonthBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
    });

    slotsForm.addEventListener('submit', (e) => {
        slotsDataInput.value = JSON.stringify(current_slots);
    });

    if (consultTypeSelect) {
        consultTypeSelect.addEventListener('change', renderPanel);
    }

    // Initial render
    current_slots = normalizeSlots(raw_slots);
    renderCalendar();
    renderSlotEditor();
});
</script>
{% endblock %}